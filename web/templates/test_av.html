<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æœ¬åœ°æ‘„åƒå¤´ä¸éº¦å…‹é£æµ‹è¯•</title>
    <style>
      :root {
        color-scheme: light dark;
      }

      body {
        font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont,
          "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
        color: #f8fafc;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      header {
        width: min(960px, 90vw);
        text-align: center;
        margin: 3rem 0 2rem;
      }

      main {
        width: min(960px, 90vw);
        background: rgba(15, 23, 42, 0.72);
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 24px;
        box-shadow: 0 40px 120px rgba(15, 23, 42, 0.4);
        padding: 2.5rem 2rem 3rem;
        backdrop-filter: blur(24px);
      }

      h1 {
        font-size: clamp(2rem, 2.4rem, 3rem);
        margin-bottom: 0.5rem;
      }

      p.description {
        font-size: 1rem;
        color: rgba(226, 232, 240, 0.85);
        line-height: 1.6;
      }

      section + section {
        margin-top: 2.5rem;
      }

      .controls {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 1.5rem;
      }

      button {
        border: none;
        border-radius: 999px;
        padding: 0.75rem 1.8rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.18s ease, box-shadow 0.18s ease;
      }

      button.primary {
        background: linear-gradient(135deg, #38bdf8 0%, #6366f1 100%);
        color: #0f172a;
        box-shadow: 0 14px 40px rgba(14, 165, 233, 0.35);
      }

      button.secondary {
        background: rgba(148, 163, 184, 0.16);
        color: #e2e8f0;
        border: 1px solid rgba(148, 163, 184, 0.4);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      button:not(:disabled):hover {
        transform: translateY(-1px) scale(1.01);
        box-shadow: 0 16px 32px rgba(14, 165, 233, 0.2);
      }

      .video-wrapper {
        position: relative;
        overflow: hidden;
        border-radius: 20px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.6);
        aspect-ratio: 16 / 9;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        color: rgba(148, 163, 184, 0.9);
      }

      .placeholder svg {
        width: 72px;
        height: 72px;
      }

      .status-list {
        list-style: none;
        padding: 0;
        margin: 1.5rem 0 0;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.2rem;
      }

      .status-item {
        background: rgba(15, 23, 42, 0.7);
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.28);
        padding: 1.2rem 1.4rem;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .status-item h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: #bae6fd;
      }

      .status-item span {
        font-size: 0.95rem;
        color: rgba(226, 232, 240, 0.85);
      }

      .meter {
        position: relative;
        width: 100%;
        height: 12px;
        border-radius: 999px;
        background: rgba(71, 85, 105, 0.6);
        overflow: hidden;
        margin-top: 0.6rem;
      }

      .meter-fill {
        position: absolute;
        inset: 0;
        width: 0%;
        background: linear-gradient(90deg, #34d399 0%, #facc15 60%, #f97316 100%);
        transition: width 0.1s ease-out;
      }

      .log {
        background: rgba(15, 23, 42, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.28);
        border-radius: 16px;
        padding: 1.2rem;
        margin-top: 1.5rem;
        font-size: 0.95rem;
        line-height: 1.6;
        color: rgba(203, 213, 225, 0.9);
        white-space: pre-wrap;
      }

      @media (max-width: 640px) {
        main {
          padding: 2rem 1.25rem 2.5rem;
        }

        .controls {
          flex-direction: column;
        }

        button {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>æœ¬åœ°æ‘„åƒå¤´ä¸éº¦å…‹é£æµ‹è¯•</h1>
      <p class="description">
        ç‚¹å‡»â€œå¼€å§‹æµ‹è¯•â€åè¯·å…è®¸æµè§ˆå™¨è®¿é—®æ‘„åƒå¤´ä¸éº¦å…‹é£ã€‚è§†é¢‘ç”»é¢ã€éŸ³é‡æŒ‡ç¤ºæ¡ä¸è®¾å¤‡ä¿¡æ¯ä¼šå®æ—¶æ˜¾ç¤ºï¼Œå¸®åŠ©ä½ å¿«é€ŸéªŒè¯è®¾å¤‡æ˜¯å¦å·¥ä½œæ­£å¸¸ã€‚
      </p>
    </header>
    <main>
      <section>
        <div class="video-wrapper">
          <video id="video" autoplay playsinline muted></video>
          <div id="placeholder" class="placeholder">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.4">
              <path
                d="M4 7a2 2 0 0 1 2-2h4l2 2h6a2 2 0 0 1 2 2v1M4 7v10a2 2 0 0 0 2 2h12"
              />
              <path
                d="M14 18v-3h4v1a2 2 0 0 0 2 2h0M3 3l18 18"
                stroke-linecap="round"
              />
            </svg>
            <span>æ‘„åƒå¤´ç”»é¢å°†åœ¨è¿™é‡Œæ˜¾ç¤º</span>
          </div>
        </div>
        <div class="controls">
          <button id="startBtn" class="primary">å¼€å§‹æµ‹è¯•</button>
          <button id="stopBtn" class="secondary" disabled>åœæ­¢å¹¶é‡Šæ”¾è®¾å¤‡</button>
        </div>
      </section>

      <section>
        <ul class="status-list">
          <li class="status-item">
            <h3>æ‘„åƒå¤´çŠ¶æ€</h3>
            <span id="cameraStatus">æœªå¼€å§‹</span>
          </li>
          <li class="status-item">
            <h3>éº¦å…‹é£çŠ¶æ€</h3>
            <span id="microphoneStatus">æœªå¼€å§‹</span>
            <div class="meter">
              <div id="audioLevel" class="meter-fill"></div>
            </div>
          </li>
          <li class="status-item">
            <h3>å·²ä½¿ç”¨çš„è®¾å¤‡</h3>
            <span id="deviceInfo">ç­‰å¾…æˆæƒ...</span>
          </li>
        </ul>
      </section>

      <section>
        <div class="status-item log">
          <strong>æç¤º</strong>
          <div id="log">1. ç‚¹å‡»å¼€å§‹åæ ¹æ®æµè§ˆå™¨æç¤ºæˆäºˆæƒé™ã€‚
2. å¦‚æœå¤šæ¬¡æ‹’ç»ï¼Œéœ€è¦åœ¨æµè§ˆå™¨åœ°å€æ é‡æ–°å…è®¸è®¿é—®ã€‚
3. å¦‚éœ€åˆ‡æ¢åˆ°å…¶å®ƒè®¾å¤‡ï¼Œè¯·å…ˆåœæ­¢æµ‹è¯•å†é‡æ–°å¼€å§‹ã€‚
          </div>
        </div>
      </section>
    </main>

    <script>
      const videoEl = document.getElementById("video");
      const placeholderEl = document.getElementById("placeholder");
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const cameraStatusEl = document.getElementById("cameraStatus");
      const micStatusEl = document.getElementById("microphoneStatus");
      const deviceInfoEl = document.getElementById("deviceInfo");
      const audioLevelEl = document.getElementById("audioLevel");
      const logEl = document.getElementById("log");

      let currentStream = null;
      let audioContext = null;
      let audioAnalyser = null;
      let animationFrame = null;

      async function startTest() {
        if (!navigator.mediaDevices?.getUserMedia) {
          appendLog("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ getUserMedia APIï¼Œè¯·æ›´æ¢ç°ä»£æµè§ˆå™¨ã€‚");
          return;
        }

        try {
          startBtn.disabled = true;
          stopBtn.disabled = false;
          appendLog("è¯·æ±‚æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™...");

          const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: { ideal: 1280 }, height: { ideal: 720 } },
            audio: { echoCancellation: true, noiseSuppression: true },
          });

          handleStream(stream);
          appendLog("è®¾å¤‡å·²æˆåŠŸè¿æ¥ã€‚");
        } catch (error) {
          startBtn.disabled = false;
          stopBtn.disabled = true;
          handleError(error);
        }
      }

      function handleStream(stream) {
        stopCurrentStream();
        currentStream = stream;

        placeholderEl.style.display = "none";
        videoEl.srcObject = stream;
        videoEl.muted = true;
        videoEl.play().catch(() => {
          appendLog("æµè§ˆå™¨é˜»æ­¢äº†è‡ªåŠ¨æ’­æ”¾ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»è§†é¢‘å¼€å§‹ã€‚");
        });

        const videoTracks = stream.getVideoTracks();
        const audioTracks = stream.getAudioTracks();

        if (videoTracks.length) {
          cameraStatusEl.textContent = `å·²è¿æ¥ï¼š${videoTracks[0].label || "æ‘„åƒå¤´"}`;
        } else {
          cameraStatusEl.textContent = "æœªæ£€æµ‹åˆ°æ‘„åƒå¤´";
        }

        if (audioTracks.length) {
          micStatusEl.textContent = `å·²è¿æ¥ï¼š${audioTracks[0].label || "éº¦å…‹é£"}`;
        } else {
          micStatusEl.textContent = "æœªæ£€æµ‹åˆ°éº¦å…‹é£";
        }

        deviceInfoEl.textContent = [
          ...videoTracks.map((track) => `ğŸ¥ ${track.label || "æ‘„åƒå¤´"}`),
          ...audioTracks.map((track) => `ğŸ™ï¸ ${track.label || "éº¦å…‹é£"}`),
        ].join("\n") || "æœªæ£€æµ‹åˆ°ä»»ä½•åª’ä½“è½¨é“";

        setupAudioAnalyser(stream);
      }

      function setupAudioAnalyser(stream) {
        stopAudioAnalyser();

        try {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const source = audioContext.createMediaStreamSource(stream);
          audioAnalyser = audioContext.createAnalyser();
          audioAnalyser.fftSize = 256;
          source.connect(audioAnalyser);
          renderAudioLevel();
        } catch (error) {
          micStatusEl.textContent = "æ— æ³•åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡";
          appendLog(`éŸ³é¢‘åˆ†æå™¨åˆå§‹åŒ–å¤±è´¥ï¼š${error.message}`);
        }
      }

      function renderAudioLevel() {
        if (!audioAnalyser) return;
        const dataArray = new Uint8Array(audioAnalyser.frequencyBinCount);

        const draw = () => {
          audioAnalyser.getByteFrequencyData(dataArray);
          const max = Math.max(...dataArray);
          const level = Math.min(100, Math.round((max / 255) * 100));
          audioLevelEl.style.width = `${level}%`;
          animationFrame = requestAnimationFrame(draw);
        };

        draw();
      }

      function stopAudioAnalyser() {
        if (animationFrame) {
          cancelAnimationFrame(animationFrame);
          animationFrame = null;
        }
        if (audioContext) {
          audioContext.close();
          audioContext = null;
        }
        audioAnalyser = null;
        audioLevelEl.style.width = "0%";
      }

      function stopCurrentStream() {
        if (!currentStream) return;
        currentStream.getTracks().forEach((track) => track.stop());
        currentStream = null;
      }

      function stopTest() {
        stopCurrentStream();
        stopAudioAnalyser();
        videoEl.srcObject = null;
        placeholderEl.style.display = "flex";
        cameraStatusEl.textContent = "å·²åœæ­¢";
        micStatusEl.textContent = "å·²åœæ­¢";
        deviceInfoEl.textContent = "å·²é‡Šæ”¾è®¾å¤‡èµ„æº";
        startBtn.disabled = false;
        stopBtn.disabled = true;
        appendLog("å·²åœæ­¢æµ‹è¯•å¹¶é‡Šæ”¾è®¾å¤‡ã€‚");
      }

      function handleError(error) {
        let message = "æ— æ³•è®¿é—®è®¾å¤‡";

        if (error.name === "NotAllowedError") {
          message = "å·²æ‹’ç»è®¿é—®æƒé™ï¼Œè¯·åœ¨æµè§ˆå™¨åœ°å€æ é‡æ–°å…è®¸æ‘„åƒå¤´/éº¦å…‹é£è®¿é—®ã€‚";
        } else if (error.name === "NotFoundError") {
          message = "æœªæ£€æµ‹åˆ°å¯ç”¨çš„æ‘„åƒå¤´æˆ–éº¦å…‹é£ã€‚";
        } else if (error.name === "NotReadableError") {
          message = "è®¾å¤‡è¢«å…¶ä»–åº”ç”¨å ç”¨ï¼Œè¯·å…³é—­åé‡è¯•ã€‚";
        } else if (error.name === "OverconstrainedError") {
          message = "æ‰¾ä¸åˆ°ç¬¦åˆè¦æ±‚çš„è®¾å¤‡ï¼Œè¯·è°ƒæ•´åˆ†è¾¨ç‡æˆ–é€‰æ‹©å…¶ä»–è®¾å¤‡ã€‚";
        } else if (error.message) {
          message = error.message;
        }

        appendLog(message);
        cameraStatusEl.textContent = "è¿æ¥å¤±è´¥";
        micStatusEl.textContent = "è¿æ¥å¤±è´¥";
      }

      function appendLog(text) {
        const time = new Date().toLocaleTimeString();
        logEl.textContent = `${time} Â· ${text}\n${logEl.textContent}`;
      }

      startBtn.addEventListener("click", startTest);
      stopBtn.addEventListener("click", stopTest);

      window.addEventListener("beforeunload", stopTest);
    </script>
  </body>
</html>
